---
title: "Figure2_Selection"
author: "Eva Brigos"
date: "2025-05-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here I want to generate the main figure of the evolutionary analysis.

# Load required libraries

```{r}
library(ggplot2)
library(dplyr)
library(cowplot)
```

# Load data-frames

```{r}
sds_fertility_earliest <- read.csv("../data/supplementary_fertility_SDS_earliest_FertilityIncreasing.tsv", sep = "\t")
ihs_fertility_earliest <- read.csv("../data/supplementary_fertility_iHS_earliest_FertilityIncreasing.tsv", sep = "\t")
sds_longevity_earliest <- read.csv("../data/supplementary_longevity_SDS_earliest_LongevityIncreasing.tsv", sep = "\t")
ihs_longevity_earliest <- read.csv("../data/supplementary_longevity_iHS_earliest_LongevityIncreasing.tsv", sep = "\t")
```

Onset age:

```{r}
ado <- read.csv("../data/onset_age_62diseases_v17.01.2025_FinRegistryR11.tsv", sep = "\t")
names(ado) <- c("DiseaseTrait", "ADO_5", "ADO_50", "ADO_95")
```

# One-sample t-test

```{r}
# Fertility-increasing
t.test(sds_fertility_earliest$FertilityIncreasing_SDS, mu = 0, alternative = "greater", conf.level = 0.95)

# Positive and Negative separately
test_positive <- sds_fertility_earliest[sds_fertility_earliest$PleiotropySign == "positive", ]
test_negative <- sds_fertility_earliest[sds_fertility_earliest$PleiotropySign == "negative", ]

t.test(test_positive$FertilityIncreasing_SDS, mu = 0, alternative = "greater", conf.level = 0.95)
t.test(test_negative$FertilityIncreasing_SDS, mu = 0, alternative = "greater", conf.level = 0.95)
```

# CUMULATIVE Fertility SDS (disease-risk alleles):

```{r}
sds_fertility <- merge(sds_fertility_earliest, ado, by = "DiseaseTrait")
```

Prepare data to plot:

```{r}
age <- c(10, 20, 30, 40, 50, 60, 70)

# List
mean_array <- c()
se_array <- c()
pleiotropy_array <- c()
age_array1 <- c()
pvalues_array <- c()
age_array2 <- c()

for (i in age) {
  # subset
  df <- sds_fertility[sds_fertility$ADO_5 <= i, ]
  # positive vs negative
  pos <- df[df$PleiotropySign == "positive", ]
  neg <- df[df$PleiotropySign == "negative", ]
  # mean and se
  pos_mean <- mean(pos$RiskAllele_SDS, na.rm = TRUE)
  mean_array <- c(mean_array, pos_mean)
  pos_se <- sd(pos$RiskAllele_SDS, na.rm = TRUE) / sqrt(sum(!is.na(pos$RiskAllele_SDS)))
  se_array <- c(se_array, pos_se)
  neg_mean <- mean(neg$RiskAllele_SDS, na.rm = TRUE)
  mean_array <- c(mean_array, neg_mean)
  neg_se <- sd(neg$RiskAllele_SDS, na.rm = TRUE) / sqrt(sum(!is.na(neg$RiskAllele_SDS)))
  se_array <- c(se_array, neg_se)
  pleiotropy_array <- c(pleiotropy_array, "positive", "negative")
  age_array1 <- c(age_array1, i, i)
  # MW Test
  if (nrow(pos) == 0 | nrow(neg) == 0) {
    pvalues_array <- c(pvalues_array, NA)
    age_array2 <- c(age_array2, i)
  } else {
    test_result <- wilcox.test(pos$RiskAllele_SDS, neg$RiskAllele_SDS)
    pvalues_array <- c(pvalues_array, test_result$p.value)
    age_array2 <- c(age_array2, i)
  }
}

# Put in data-frames
main_df <- data.frame(OnsetAge = age_array1, Mean = mean_array, SE = se_array, PleiotropySign = pleiotropy_array)
pvalue_df <- data.frame(OnsetAge = age_array2, MWPvalue = pvalues_array)
pvalue_df$log10Pvalue <- -log10(pvalue_df$MWPvalue)
pvalue_df$Significance <- ifelse(pvalue_df$MWPvalue < 0.05, "Significant", "Not Significant")
```

Plot:

```{r}
# Sub-plot 1: mean and SE
a1 <- ggplot(main_df,
             aes(x = OnsetAge,
                 y = Mean,
                 color = PleiotropySign,
                 fill  = PleiotropySign,
                 group = PleiotropySign)) +

  # Shaded SE ribbon
  geom_ribbon(aes(ymin = Mean - SE,
                  ymax = Mean + SE),
              alpha = 0.2,
              color = NA) +
  
  # X-axis continuous
  scale_x_continuous(breaks = seq(10, 70, by = 10), limits = c(10, 70)) +

  # Dashed mean lines + points
  geom_line(linetype = "dashed",
            linewidth = 0.5) +
  geom_point(size = 2) +

  # manual colors
  scale_color_manual(values = c("positive" = "#023E8A",
                                "negative" = "#990000")) +
  scale_fill_manual(values  = c("positive" = "#023E8A",
                                "negative" = "#990000")) +

  labs(x = "Onset Age",
       y = "SDS") +
  theme_bw() +
  theme(
    legend.position   = "none",
    panel.grid        = element_blank(),
    axis.title.x      = element_blank(),
    axis.text.x       = element_blank(),
    axis.text.y       = element_text(size = 7, family = "Arial", color = "black", margin = margin(r = 5)),
    axis.ticks        = element_line(linewidth = 0.7),
    axis.title.y      = element_text(size = 7, family = "Arial", color = "black", margin = margin(r = 10), face = "bold"),
    axis.line         = element_line(color = "black"),
    plot.margin = margin(t = 10, r = 10, b = 1, l = 10)
  )


# Sub-plot 2: MW p-value
a2 <- ggplot(pvalue_df, aes(x = OnsetAge, y = log10Pvalue, colour = Significance)) +
  geom_hline(yintercept = 1.3, linetype = "dashed", color = "gray", linewidth = 0.5) +
  geom_point(stat = "identity", size = 1.5) +
  labs(x = "Onset Age", y = expression(italic(-log)[10] ~ italic("p-value"))) +
  scale_color_manual(values = c("Significant" = "black", "Not Significant" = "gray")) +
  scale_y_continuous(breaks = seq(1, 3.5, by = 0.5), limits = c(1, 3.5)) +
  scale_x_continuous(breaks = seq(10, 70, by = 10), limits = c(10, 70)) +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.title.x = element_text(size = 7, family = "Arial", color = "black", margin = margin(t = 10), face = "bold"),
        axis.text.x = element_text(size = 7, family = "Arial", color = "black", margin = margin(t = 8)),
        axis.text.y = element_text(size = 7, family = "Arial", color = "black", margin = margin(r = 5)),
        axis.ticks = element_line(color = "black"),
        axis.title.y = element_text(size = 7, family = "Arial", color = "black", margin = margin(r = 5)),
        axis.line = element_line(color = "black"),
        plot.margin = margin(t = 1, r = 10, b = 20, l = 10))

# Aggregate the plots
cumulative_sds <- plot_grid(a1, a2, ncol = 1, align = "v", rel_heights = c(1, 0.5))
```

# SDS Fertility: positive vs. negative

```{r}
# Extract values
sds_fertility_positive <- sds_fertility_earliest %>%
  filter(PleiotropySign == "positive") %>%
  pull(RiskAllele_SDS) %>% 
  as.numeric()

median_P <- median(sds_fertility_positive)

sds_fertility_negative <- sds_fertility_earliest %>%
  filter(PleiotropySign == "negative") %>%
  pull(RiskAllele_SDS) %>% 
  as.numeric() 

median_N <- median(sds_fertility_negative)

# Test
t <- wilcox.test(sds_fertility_positive, sds_fertility_negative, alternative = "greater", paired = FALSE)
# M.W. P = 2.7e-04

# Data-frame
df_pos_neg <- data.frame(
  value = c(sds_fertility_negative, sds_fertility_positive),
  group = factor(rep(c("Negative\nPleiotropies", "Positive\nPleiotropies"),
                     times = c(length(sds_fertility_negative), length(sds_fertility_positive))))
)

# Plot
b <- ggplot(df_pos_neg, aes(x = group, y = value, fill = group, color = group)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray", linewidth = 0.8) +
  geom_boxplot(width = 0.4, fill = "white", outlier.shape = NA, coef = 1, size = 1) +
  annotate("text", x = 1.5, y = 3, label = "***", size = 3, color = "black", family = "Arial") +
  geom_segment(aes(x = 1, xend = 1, y = 2.6, yend = 2.8), color = "black", linewidth = 0.2) +
  geom_segment(aes(x = 2, xend = 2, y = 2.6, yend = 2.8), color = "black", linewidth = 0.2) +
  geom_segment(aes(x = 1, xend = 2, y = 2.8, yend = 2.8), color = "black", linewidth = 0.2) +
  scale_color_manual(values = c("Positive\nPleiotropies" = "#023E8A",
                                "Negative\nPleiotropies" = "#990000")) +
  scale_x_discrete(expand = c(0.8, 0)) +
  coord_cartesian(ylim = c(-3,3)) +
  theme_bw() +
  labs(y = "SDS") +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 7, family = "Arial", color = "black", margin = margin(t = 5)),
        axis.text.y = element_text(size = 7, family = "Arial", color = "black", margin = margin(r = 5)),
        axis.ticks = element_line(linewidth = 0.7),
        axis.title.y = element_text(size = 7, family = "Arial", color = "black", face = "bold"),
        axis.line = element_line(color = "black", linewidth = 0.7),
        plot.margin = margin(t = 1, r = 5, b = 1, l = 10))
```

# SDS: Fertility vs disease-risk

```{r}
# Extract values
sds_fertility_fertility <- sds_fertility_earliest %>%
  select(FertilityIncreasing_SDS) %>%
  unlist() %>%
  as.numeric()

median_F <- median(sds_fertility_fertility)

sds_fertility_risk <- sds_fertility_earliest %>%
  select(RiskAllele_SDS) %>%
  unlist() %>%
  as.numeric()

median_R <- median(sds_fertility_risk)

# Test
wilcox.test(sds_fertility_fertility, sds_fertility_risk, alternative = "greater", paired = FALSE)
#M.W. P = 2.5e-03

# Data-frame
df_fert_risk <- data.frame(
  value = c(sds_fertility_risk, sds_fertility_fertility),
  group = factor(rep(c("Disease-risk\nAlleles", "Fertility\nIncreasing\nAlleles"),
                     times = c(length(sds_fertility_risk), length(sds_fertility_fertility))))
)

# Plot
c <- ggplot(df_fert_risk, aes(x = group, y = value, fill = group)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray", linewidth = 0.8) +
  geom_boxplot(width = 0.4, fill = "white", outlier.shape = NA, coef = 1, size = 1) +
  annotate("text", x = 1.5, y = 3, label = "**", size = 3, color = "black", family = "Arial") +
  geom_segment(aes(x = 1, xend = 1, y = 2.6, yend = 2.8), color = "black", linewidth = 0.2) +
  geom_segment(aes(x = 2, xend = 2, y = 2.6, yend = 2.8), color = "black", linewidth = 0.2) +
  geom_segment(aes(x = 1, xend = 2, y = 2.8, yend = 2.8), color = "black", linewidth = 0.2) +
  scale_x_discrete(expand = c(0.8, 0)) +
  coord_cartesian(ylim = c(-3,3)) +
  theme_bw() +
  labs(y = "SDS") +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 7, family = "Arial", color = "black", margin = margin(t = 5)),
        axis.text.y = element_text(size = 7, family = "Arial", color = "black", margin = margin(r = 5)),
        axis.ticks = element_line(linewidth = 0.7),
        axis.title.y = element_text(size = 7, family = "Arial", color = "black", face = "bold"),
        axis.line = element_line(color = "black", linewidth = 0.7),
        plot.margin = margin(t = 0, r = 5, b = 1, l = 10))
```

Aggregate:

```{r}
# Combine the plots
box_plots <- plot_grid(b, c, ncol = 2, align = "h", rel_heights = c(1, 1), label_size = 10, label_fontfamily = "Arial")
```

# Effect sizes

Fertility pleiotropies SDS:

```{r}
effect_sizes_for_fertility_pleios <- read.csv("../data/merged_fertility_pleiotropy_results_to_check_plifespan_effectsizes.csv", sep = ",")

# Find the fertility-increasing alleles
effect_sizes_for_fertility_pleios$FertilityIncreasing_Allele <- ifelse(effect_sizes_for_fertility_pleios$zscore_fertility_gwas > 0, effect_sizes_for_fertility_pleios$A1, effect_sizes_for_fertility_pleios$A2)

# Find the longevity effect size for fertility-increasing alleles
effect_sizes_for_fertility_pleios$FertilityIncreasing_LongevityEffect <- ifelse(effect_sizes_for_fertility_pleios$FertilityIncreasing_Allele == effect_sizes_for_fertility_pleios$A1_PLIFESPAN, effect_sizes_for_fertility_pleios$Z_PLIFESPAN, -effect_sizes_for_fertility_pleios$Z_PLIFESPAN)

median_FL <- median(effect_sizes_for_fertility_pleios$FertilityIncreasing_LongevityEffect, na.rm = TRUE)

# Group them
effect_sizes_for_fertility_pleios$group <- "Fertility-increasing\nAlleles"

d <- ggplot(effect_sizes_for_fertility_pleios, aes(x = group, y = FertilityIncreasing_LongevityEffect, fill = group)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray", linewidth = 0.8) +
  geom_boxplot(width = 0.4, fill = "white", outlier.shape = NA, coef = 1, size = 1) +
  annotate("text", x = 1, y = 2.5, label = "***", size = 3, color = "black", family = "Arial") +
  coord_cartesian(ylim = c(-4,3)) +
  theme_bw() +
  labs(y = "Z-score Longevity") +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 7, family = "Arial", color = "black", margin = margin(t = 5)),
        axis.text.y = element_text(size = 7, family = "Arial", color = "black", margin = margin(r = 5)),
        axis.ticks = element_line(linewidth = 0.7),
        axis.title.y = element_text(size = 7, family = "Arial", color = "black", face = "bold", margin = margin(r = 3)),
        axis.line = element_line(color = "black", linewidth = 0.7),
        plot.margin = margin(t = 1, r = 10, b = 1, l = 10))
```

```{r}
t.test(effect_sizes_for_fertility_pleios$FertilityIncreasing_LongevityEffect, mu = 0, alternative = "less", conf.level = 0.95)
# p-value = 3.043e-10
```

Aggregate box-plots:

```{r}
all_box <- plot_grid(b, c, d, ncol = 3, align = "h", rel_widths = c(1, 1, 0.7), labels = c("b", "c", "d"),
                     label_fontfamily = "Arial",
                     label_size = 10)
```

Put everything together:

```{r}
selection <- plot_grid(cumulative_sds, all_box, ncol = 1, align = "h", rel_heights = c(1, 0.6), labels = c("a", ""),
                   label_fontfamily = "Arial",
                   label_size = 10)
```

Save:

```{r}
ggsave("./Figure2_selection.png", plot = selection,
       width = 180, 
       height = 170, 
       units = "mm",
       dpi = 400)
```

